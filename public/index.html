<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEXC Spot-Perp Arbitrage Finder | Buy Spot Short Perp</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding: 10px;
            background: #0f172a;
            color: #e2e8f0;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #f1f5f9;
            margin-bottom: 10px;
            font-size: 2em;
        }
        .header p {
            color: #94a3b8;
            margin: 5px 0;
        }
        .strategy-info {
            background: #1e293b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
        }
        .strategy-info strong {
            color: #60a5fa;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #10b981;
        }
        .stat-label {
            color: #94a3b8;
            margin-top: 5px;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .controls button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        .controls button:hover {
            background: #2563eb;
        }
        .controls button:disabled {
            background: #475569;
            cursor: not-allowed;
        }
        .mode-btn {
            background: #334155;
            color: #94a3b8;
            border: 2px solid #475569;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s;
            margin: 0 5px;
        }
        .mode-btn:hover {
            background: #3f4f66;
            border-color: #60a5fa;
        }
        .mode-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .controls input {
            background: #1e293b;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 14px;
            width: 200px;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #94a3b8;
        }
        .error {
            background: #7f1d1d;
            color: #fecaca;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #dc2626;
        }
        .table-container {
            background: #1e293b;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        thead {
            background: #334155;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #f1f5f9;
            white-space: nowrap;
        }
        th.sortable {
            cursor: pointer;
            user-select: none;
        }
        th.sortable:hover {
            background: #3f4f66;
        }
        th.sortable::after {
            content: ' ⇅';
            opacity: 0.3;
        }
        th.sorted-asc::after {
            content: ' ↑';
            opacity: 1;
        }
        th.sorted-desc::after {
            content: ' ↓';
            opacity: 1;
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #334155;
        }
        tr:hover {
            background: #273549;
        }
        .positive {
            color: #34d399;
        }
        .negative {
            color: #f87171;
        }
        .symbol {
            font-weight: 600;
            color: #60a5fa;
        }
        .number {
            font-family: 'Courier New', monospace;
        }
        .highlight-row {
            background: #1e3a5f !important;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .updating {
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MEXC Spot-Perp Arbitrage Finder</h1>
            <p id="strategyTitle">Buy Spot (Ask) → Short Perp (Bid)</p>
        </div>

        <div class="strategy-selector" style="text-align: center; margin-bottom: 20px;">
            <button id="mode1Btn" class="mode-btn active" onclick="switchMode('buySpotShortPerp')">
                Buy Spot → Short Perp
            </button>
            <button id="mode2Btn" class="mode-btn" onclick="switchMode('sellSpotLongPerp')">
                Sell Spot → Long Perp
            </button>
        </div>

        <div class="strategy-info" id="strategyInfo">
            <strong>Strategy:</strong> Buy on Spot Market (best ask) and simultaneously Short on Perpetual Market (best bid)<br>
            <strong>Formula:</strong> Spread % = (Perp Bid - Spot Ask) / ((Perp Bid + Spot Ask) / 2) × 100<br>
            <strong>Goal:</strong> Perp bid price should be higher than spot ask price (showing only positive spreads)
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalPairs">-</div>
                <div class="stat-label">Total Pairs</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="maxSpread">-</div>
                <div class="stat-label">Max Spread %</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgSpread">-</div>
                <div class="stat-label">Avg Spread %</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="lastUpdate">-</div>
                <div class="stat-label">Last Update</div>
            </div>
        </div>

        <div class="controls">
            <button id="refreshBtn" onclick="loadData()">Refresh Data</button>
            <button id="toggleAutoRefresh" onclick="toggleAutoRefresh()">Auto-Refresh: OFF</button>
            <input type="text" id="searchInput" placeholder="Search symbol..." onkeyup="filterTable()">
            <input type="number" id="minSpread" placeholder="Min spread %" step="0.01" onchange="filterTable()">
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="loading" class="loading">Loading data...</div>

        <div class="table-container" id="tableContainer" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortTable('symbol')">Symbol</th>
                        <th class="sortable" onclick="sortTable('spreadPercent')">Spread %</th>
                        <th class="sortable" onclick="sortTable('price1')" id="header1">Spot Ask</th>
                        <th class="sortable" onclick="sortTable('price2')" id="header2">Perp Bid</th>
                        <th class="sortable" onclick="sortTable('difference')">Difference</th>
                        <th class="sortable" onclick="sortTable('qty1')" id="headerQty1">Spot Ask Qty</th>
                        <th class="sortable" onclick="sortTable('qty2')" id="headerQty2">Perp Bid Qty</th>
                        <th class="sortable" onclick="sortTable('volume24h')">24h Volume</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let rawData = [];
        let processedData = [];
        let currentMode = 'buySpotShortPerp'; // or 'sellSpotLongPerp'
        let sortColumn = 'spreadPercent';
        let sortDirection = 'desc';
        let autoRefreshInterval = null;
        let isAutoRefresh = false;

        function switchMode(mode) {
            currentMode = mode;

            // Update button styles
            document.getElementById('mode1Btn').classList.toggle('active', mode === 'buySpotShortPerp');
            document.getElementById('mode2Btn').classList.toggle('active', mode === 'sellSpotLongPerp');

            // Update UI text
            if (mode === 'buySpotShortPerp') {
                document.getElementById('strategyTitle').textContent = 'Buy Spot (Ask) → Short Perp (Bid)';
                document.getElementById('strategyInfo').innerHTML =
                    '<strong>Strategy:</strong> Buy on Spot Market (best ask) and simultaneously Short on Perpetual Market (best bid)<br>' +
                    '<strong>Formula:</strong> Spread % = (Perp Bid - Spot Ask) / ((Perp Bid + Spot Ask) / 2) × 100<br>' +
                    '<strong>Goal:</strong> Perp bid price should be higher than spot ask price (showing only positive spreads)';
                document.getElementById('header1').textContent = 'Spot Ask';
                document.getElementById('header2').textContent = 'Perp Bid';
                document.getElementById('headerQty1').textContent = 'Spot Ask Qty';
                document.getElementById('headerQty2').textContent = 'Perp Bid Qty';
            } else {
                document.getElementById('strategyTitle').textContent = 'Sell Spot (Bid) → Long Perp (Ask)';
                document.getElementById('strategyInfo').innerHTML =
                    '<strong>Strategy:</strong> Sell on Spot Market (best bid) and simultaneously Long on Perpetual Market (best ask)<br>' +
                    '<strong>Formula:</strong> Spread % = (Spot Bid - Perp Ask) / ((Spot Bid + Perp Ask) / 2) × 100<br>' +
                    '<strong>Goal:</strong> Spot bid price should be higher than perp ask price (showing only positive spreads)';
                document.getElementById('header1').textContent = 'Spot Bid';
                document.getElementById('header2').textContent = 'Perp Ask';
                document.getElementById('headerQty1').textContent = 'Spot Bid Qty';
                document.getElementById('headerQty2').textContent = 'Perp Ask Qty';
            }

            // Reprocess and render data
            processData();
            updateStats({ timestamp: new Date().toISOString() });
            renderTable();
        }

        function processData() {
            processedData = rawData.map(item => {
                let price1, price2, qty1, qty2, difference, spreadPercent;

                if (currentMode === 'buySpotShortPerp') {
                    // Buy spot (pay ask), short perp (receive bid)
                    price1 = item.spotAsk;
                    price2 = item.perpBid;
                    qty1 = item.spotAskQty;
                    qty2 = item.perpBidQty;
                    difference = item.perpBid - item.spotAsk;
                } else {
                    // Sell spot (receive bid), long perp (pay ask)
                    price1 = item.spotBid;
                    price2 = item.perpAsk;
                    qty1 = item.spotBidQty;
                    qty2 = item.perpAskQty;
                    difference = item.spotBid - item.perpAsk;
                }

                const average = (price1 + price2) / 2;
                spreadPercent = (difference / average) * 100;

                return {
                    ...item,
                    price1,
                    price2,
                    qty1,
                    qty2,
                    difference,
                    spreadPercent
                };
            }).filter(item => item.spreadPercent > 0); // Only show positive spreads
        }

        async function loadData() {
            const refreshBtn = document.getElementById('refreshBtn');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const tableContainer = document.getElementById('tableContainer');

            refreshBtn.disabled = true;
            refreshBtn.textContent = 'Loading...';
            refreshBtn.classList.add('updating');
            loading.style.display = 'block';
            error.style.display = 'none';
            tableContainer.style.display = 'none';

            try {
                const response = await fetch('/api/compare');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Unknown error');
                }

                rawData = result.data;
                processData();
                updateStats(result);
                renderTable();

                loading.style.display = 'none';
                tableContainer.style.display = 'block';
            } catch (err) {
                console.error('Error loading data:', err);
                error.textContent = `Error: ${err.message}`;
                error.style.display = 'block';
                loading.style.display = 'none';
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Refresh Data';
                refreshBtn.classList.remove('updating');
            }
        }

        function updateStats(result) {
            document.getElementById('totalPairs').textContent = processedData.length;

            if (processedData.length > 0) {
                const spreads = processedData.map(d => d.spreadPercent);
                const maxSpread = Math.max(...spreads);
                const avgSpread = spreads.reduce((a, b) => a + b, 0) / spreads.length;

                document.getElementById('maxSpread').textContent = maxSpread.toFixed(4) + '%';
                document.getElementById('avgSpread').textContent = avgSpread.toFixed(4) + '%';
            } else {
                document.getElementById('maxSpread').textContent = '-';
                document.getElementById('avgSpread').textContent = '-';
            }

            const time = new Date(result.timestamp);
            document.getElementById('lastUpdate').textContent = time.toLocaleTimeString();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const searchTerm = document.getElementById('searchInput').value.toUpperCase();
            const minSpread = parseFloat(document.getElementById('minSpread').value) || 0;

            // Filter data
            let filteredData = processedData.filter(item => {
                const matchesSearch = item.symbol.includes(searchTerm);
                const matchesSpread = item.spreadPercent >= minSpread;
                return matchesSearch && matchesSpread;
            });

            // Sort data
            filteredData.sort((a, b) => {
                let aVal = a[sortColumn];
                let bVal = b[sortColumn];

                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            // Render rows
            tbody.innerHTML = filteredData.map(item => `
                <tr class="${item.spreadPercent > 1 ? 'highlight-row' : ''}">
                    <td class="symbol">${item.symbol}</td>
                    <td class="number positive">+${item.spreadPercent.toFixed(4)}%</td>
                    <td class="number">${formatNumber(item.price1)}</td>
                    <td class="number">${formatNumber(item.price2)}</td>
                    <td class="number positive">+${formatNumber(item.difference)}</td>
                    <td class="number">${formatNumber(item.qty1)}</td>
                    <td class="number">${formatNumber(item.qty2)}</td>
                    <td class="number">${formatLargeNumber(item.volume24h)}</td>
                </tr>
            `).join('');

            updateSortIndicators();
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'desc';
            }
            renderTable();
        }

        function updateSortIndicators() {
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });

            const columnMap = {
                'symbol': 0,
                'spreadPercent': 1,
                'price1': 2,
                'price2': 3,
                'difference': 4,
                'qty1': 5,
                'qty2': 6,
                'volume24h': 7
            };

            const index = columnMap[sortColumn];
            if (index !== undefined) {
                const th = document.querySelectorAll('th.sortable')[index];
                th.classList.add(`sorted-${sortDirection}`);
            }
        }

        function filterTable() {
            renderTable();
        }

        function toggleAutoRefresh() {
            const btn = document.getElementById('toggleAutoRefresh');
            isAutoRefresh = !isAutoRefresh;

            if (isAutoRefresh) {
                btn.textContent = 'Auto-Refresh: ON (30s)';
                btn.style.background = '#10b981';
                autoRefreshInterval = setInterval(loadData, 30000);
            } else {
                btn.textContent = 'Auto-Refresh: OFF';
                btn.style.background = '#3b82f6';
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        function formatNumber(num) {
            if (num === 0) return '0';
            if (num < 0.00001) return num.toExponential(4);
            if (num < 1) return num.toFixed(8);
            if (num < 100) return num.toFixed(6);
            return num.toFixed(2);
        }

        function formatLargeNumber(num) {
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return num.toFixed(2);
        }

        // Load data on page load
        loadData();
    </script>
</body>
</html>
